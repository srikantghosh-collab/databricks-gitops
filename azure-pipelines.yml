trigger:
- main

variables:
  PYTHON_VERSION: '3.10'

# =========================
# STAGE 1: DETECT
# =========================
stages:
- stage: Detect
  displayName: "Detect DDL Changes"
  jobs:
  - job: detect
    displayName: "Detection Job"
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
      fetchDepth: 0

    - task: UsePythonVersion@0
      inputs:
        versionSpec: $(PYTHON_VERSION)

    - script: |
        echo "Detection stage running"
      displayName: "Sanity Check Detect Stage"


# =========================
# STAGE 2: EXECUTE
# =========================
- stage: Execute
  displayName: "Execute DDL"
  dependsOn: Detect
  jobs:
  - job: execute
    displayName: "Execution Job"
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: $(PYTHON_VERSION)

    - script: |
        python -m pip install --upgrade pip
        python -m pip install databricks-sql-connector
        python -c "from databricks import sql; print('Databricks SQL OK')"
      displayName: "Install Databricks SQL Connector"

    - script: |
        python scripts/execute_ddl.py
      displayName: "Execute DDL"
      env:
        DATABRICKS_HOST: $(Databricks_Host)
        DATABRICKS_TOKEN: $(Databricks_Token)
        DATABRICKS_HTTP_PATH: $(Databricks_Http_Path)

