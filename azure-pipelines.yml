trigger:
- main

variables:
  PYTHON_VERSION: '3.10'

# =========================
# STAGE 1: DETECT
# =========================
stages:
- stage: Detect
  displayName: Detect DDL Changes
  jobs:
  - job: detect
    displayName: Detection Job
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
      fetchDepth: 0

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'

    - script: |
        python scripts/detect_ddl.py
      name: detectddl   


# =========================
# STAGE 2: MANUAL APPROVAL
# =========================
- stage: Approval
  displayName: Manual Approval for DROP
  dependsOn: Detect
  condition: |
    and(
      succeeded(),
      eq(dependencies.Detect.outputs['detect.detectddl.IS_DROP'], 'true')
    )
  jobs:
  - job: approval
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: "DROP DDL detected. Please approve to continue."
        timeoutInMinutes: 1440



# =========================
# STAGE 3: EXECUTE
# =========================
- stage: Execute
  displayName: Execute DDL
  dependsOn:
    - Detect
    - Approval
  condition: |
    and(
      succeeded(),
      eq(dependencies.Detect.outputs['detect.detectddl.HAS_DDL'], 'false')
    )
  jobs:
  - job: execute
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'

    - script: |
        python -m pip install --upgrade pip
        python -m pip install databricks-sql-connector
      displayName: Install Dependencies

    - script: |
        python scripts/execute_ddl.py
      env:
        DATABRICKS_HOST: $(Databricks_host)
        DATABRICKS_TOKEN: $(Databricks_Token)
        DATABRICKS_HTTP_PATH: $(Databricks_HTTP_Path)
